---
title: "0 - Data Transformation for Survey Data"
author: "Andika"
date: "2025-09-26"
output: html_document
---

## Loading all library

```{r, echo=TRUE, results='hide', warning=FALSE, message=FALSE}
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
```

## Data Transformation

```{r Loading Data, echo=TRUE, results='hide', warning=FALSE, message=FALSE}
df <- read_excel("C:/Users/wzj545/University of Copenhagen/KU/Research/WP4/Online Survey.xlsx")
```

## Speedy Removal Panelist

Removing panelist who finished the questionnaire under 3 minutes.

From the initial 214 respondents to 202 respondents.

```{r pressure, warning=FALSE, message=FALSE}


df2 <- df %>%
  mutate(
    start = as.POSIXct(`Importance_of_coffee_variables_Sustainability_label_(e_g_organic__FairTrade__etc_)_Time_Stamp` * 86400, origin = "1899-12-30", tz = "Europe/Copenhagen"),
    end   = as.POSIXct(BMI_Weight_Time_Stamp   * 86400, origin = "1899-12-30", tz = "Europe/Copenhagen"),
    time_taken_sec = as.numeric(difftime(end, start, units = "secs"))
  ) %>%
  filter(time_taken_sec > 3 * 60)

```

## Straight line pattern removal

Checking respondents who always pick the same number across all scale questions (Attitudinal questions), e.g always 1, 2, etc.

No respondents were eliminated.

```{r}
scale_vars <- c(names(df2)[2:16], names(df2)[98:102], names(df2)[104:110], names(df2)[112:117], names(df2)[119:126])

df2 <- df2 %>%
  rowwise() %>%
  mutate(all_same_all = n_distinct(c_across(all_of(scale_vars)), na.rm = TRUE) == 1) %>%
  ungroup() %>%
  filter(!all_same_all)
```

## Tidying DCE Data

```{r}
choice_and_time <- df2 %>% 
  select(1,18:97)
```

The dataset was divided into two parts: *choice_compact* and *time_compact*. We screened *choice_compact* for straight-line patterns and examined *time_compact* to assess completion times.

In our questionnaire, we employed validity check by using test-retest question for the forth choice set and repeated in the last choice set. In average, the overall agreement of our respondents were 81.2%, meaning that only 164 respondents consistently answered the same questions. However, we decided not to remove every respondents from our dataset and we only removed respondents who answered all 10 questions in less than 30 seconds and did not match with the test-retest validity question. We chose their first choice set as their "true" answer.

```{r echo=TRUE}
choice_compact <- choice_and_time %>%
  pivot_longer(cols = matches("^P[1-4]C[1-9]$"),
               names_to = c("profile","choice_no"),
               names_pattern = "^P(\\d+)C(\\d+)$",
               values_to = "ans") %>%
  mutate(profile = paste0("P", profile),
         choice_no = as.integer(choice_no)) %>%
  select(id, profile, choice_no, ans) %>%
  arrange(id, profile, choice_no) %>%
  pivot_wider(names_from = choice_no, values_from = ans, names_prefix = "choice_") %>%
  select(id, profile, starts_with("choice_")) %>% 
  filter(if_any(starts_with("choice_"), ~ !is.na(.)))

choice_compact <- choice_compact %>%
  rowwise() %>%
  mutate(
    n_ans   = sum(!is.na(c_across(starts_with("choice_")))),
    n_dist  = n_distinct(c_across(starts_with("choice_")), na.rm = TRUE),
    sl_row  = n_ans > 0 & n_dist == 1
  ) %>%
  ungroup() %>%
  filter(!sl_row)

check_consistency <- choice_and_time %>%
  select(id, P1C4, P2C4, P3C4, P4C4, P1Test, P2Test, P3Test, P4Test)

consistency_flags <- check_consistency %>%
  mutate(
    P1_match = P1C4 == P1Test,
    P2_match = P2C4 == P2Test,
    P3_match = P3C4 == P3Test,
    P4_match = P4C4 == P4Test,
    total_matches = rowSums(across(starts_with("P") & ends_with("match")), na.rm = TRUE)
  )

summary_consistency <- consistency_flags %>%
  summarise(
    P1_agreement = mean(P1_match, na.rm = TRUE),
    P2_agreement = mean(P2_match, na.rm = TRUE),
    P3_agreement = mean(P3_match, na.rm = TRUE),
    P4_agreement = mean(P4_match, na.rm = TRUE),
    overall_agreement = mean(c(P1_match, P2_match, P3_match, P4_match), na.rm = TRUE)
  )

print(summary_consistency)
```

```{r echo=TRUE}
time_compact <- choice_and_time %>%
  pivot_longer(cols = matches("^P[1-4]C[1-9]T$"),
               names_to = c("profile","time_no"),
               names_pattern = "^P(\\d+)C(\\d+)T$",
               values_to = "time") %>%
  mutate(profile = paste0("P", profile),
         time_no = as.integer(time_no)) %>%
  select(id, profile, time_no, time) %>%
  arrange(id, profile, time_no) %>%
  pivot_wider(names_from = time_no, values_from = time, names_prefix = "time_") %>%
  select(id, profile, starts_with("time_")) %>% 
  filter(if_any(starts_with("time_"), ~ !is.na(.)))

time_posix <- time_compact %>%
  mutate(across(starts_with("time_"),
                ~ as.POSIXct(.x * 86400, origin = "1899-12-30", tz = "Europe/Copenhagen")))

time_with_comp <- time_posix %>%
  rowwise() %>%
  mutate(
    n_times = sum(!is.na(c_across(starts_with("time_")))),
    t_min   = if (n_times > 0) min(c_across(starts_with("time_")), na.rm = TRUE) else as.POSIXct(NA),
    t_max   = if (n_times > 0) max(c_across(starts_with("time_")), na.rm = TRUE) else as.POSIXct(NA),
    completion_sec = if (n_times >= 2) as.numeric(difftime(t_max, t_min, units = "secs")) else NA_real_
  ) %>%
  ungroup()

threshold_sec <- 20 
time_flagged <- time_with_comp %>%
  mutate(speedy = !is.na(completion_sec) & completion_sec < threshold_sec)

time_nospeed <- time_flagged %>%
  filter(!( !is.na(completion_sec) & completion_sec < threshold_sec ))

overall_summary <- time_with_comp %>%
  summarise(
    n_rows            = n(),
    mean_sec          = mean(completion_sec, na.rm = TRUE),
    median_sec        = median(completion_sec, na.rm = TRUE),
    p25_sec           = quantile(completion_sec, 0.25, na.rm = TRUE),
    p75_sec           = quantile(completion_sec, 0.75, na.rm = TRUE),
    min               = min(completion_sec, na.rm = TRUE)
  )

print(overall_summary)
```

Compating the completion time (in sec) for discrete choice questions with the validity test. 0 indicates that both answers do not match.

```{r}
merged <- left_join(time_with_comp,consistency_flags, by = "id")

merged <- merged %>% select(-c(3:14, 16:27)) %>%
  arrange(completion_sec) %>% 
  filter(total_matches == 0)

head(merged, 5)
```

Filter respondents number 632 and 626. NOTE FOR MYSELF: Check 632 and 626 if they are in the sensory test.

```{r}
df2 <- df2 %>% 
  filter(!id %in% c(632, 626))
```

## Demography cleaning

BMI Age Gender: Male, Female, Other Household income in kr: Prefer not to say, from 0-100k kr to 900k kr Level of Education Residency in Denmark: Native, years stay Urbanization level Coffee frequency 1/0 Sustainability Label, Organic label CATA Reason, type of sweetener, type of lightener, type of coffee usually drink

```{r}
# Grouping BMI
df2 <- df2 %>% 
  mutate(BMI = BMI_Weight/(BMI_Height/100)^2)


df2$BMI <- cut(df2$BMI,
                 breaks = c(-Inf, 18.5, 25, 30, 35, Inf),
                 labels = c("Underweight", "Normal", "Overweight","Obese","Extremely Obese"),
                 right = FALSE)
```

```{r function to recode values}
recode_values <- function (x) {
  recode(x, "Prefer not to say" = 0, "Less than DKK 100.000" = 1,  "DKK 100.001 - 200.000" = 2, 
         "DKK 200.001 - 300.000" = 3, "DKK 300.000 - 400.000" = 4, "DKK 400.001 - 500.000" = 5, 
          "DKK 500.001 - 600.000" = 6, "DKK 600.001 - 700.000" = 7, "DKK 700.001 - 800.000" = 8, "DKK 800.001 - 900.000" = 9, "More than DKK 900.000" = 10,
         "Female" = 1, "Male" = 2, "Other" = 0,
         "Some school, no diploma" = 0, "Secondary school graduate, diploma" = 1, "Vocational training/qualification, associate degree" = 2, "Bachelor's degree" = 3, "Masters degree" = 4, "Doctorate degree" = 5,
        "Rural" = 0, "Sub-urban" = 1, "Urban" = 2,
         "Never" = 0, "Less than 1 time/month" = 1, "1-3 times/month" = 2, "1-3 times/week" = 3, "4-6 times/week" = 4,
         "Once a day" = 5, "Twice or more/day" = 6,
         "Less than one year" = 0, "1-3 years" = 1, "3-5 years" = 2, "5-10 years" = 3, "More than 10 years" = 4, "I have always lived in Denmark (native/resident since birth)" = 5,
        "Underweight" = 0, "Normal" = 1, "Overweight" = 2,"Obese" = 3,"Extremely Obese" = 4)
}

df2 <- df2 %>% 
  mutate(across(c(128,182:184,186:187,189,200)))
```

```{r Cutting the dataset based on the profile in choice set}
profile_1 <- df2[,c(1:16,18,20,22,24,26,28,30,32,34,98:102,104:110,112:117,119:126,128,182:184,186:187,189,191,200)]
profile_1 <- na.omit(profile_1)
profile_1 <- profile_1 %>%
  relocate(17:25, .after = 1)
profile_1 <- profile_1 %>% 
  mutate(Profile = 1)

profile_2 <- df2[,c(1:16,36,38,40,42,44,46,48,50,52,98:102,104:110,112:117,119:126,128,182:184,186:187,189,191,200)]
profile_2 <- na.omit(profile_2)
profile_2 <- profile_2 %>%
  relocate(17:25, .after = 1)
profile_2 <- profile_2 %>% 
  mutate(Profile = 2)

profile_3 <- df2[,c(1:16,54,56,58,60,62,64,66,68,70,98:102,104:110,112:117,119:126,128,182:184,186:187,189,191,200)]
profile_3 <- na.omit(profile_3)
profile_3 <- profile_3 %>%
  relocate(17:25, .after = 1)
profile_3 <- profile_3 %>% 
  mutate(Profile = 3)

profile_4 <- df2[,c(1:16,72,74,76,78,80,82,84,86,88,98:102,104:110,112:117,119:126,128,182:184,186:187,189,191,200)]
profile_4 <- na.omit(profile_4)
profile_4 <- profile_4 %>%
  relocate(17:25, .after = 1)
profile_4 <- profile_4 %>% 
  mutate(Profile = 4)
```

```{r loading combination of choice set}
design_raw <- read_excel("C:/Users/wzj545/University of Copenhagen/KU/Research/WP4/Combination of choice set.xlsx")
```

```{r transforming into long data for choice for each profile}
profile_long_1 <- profile_1 %>%
  pivot_longer(
    cols = starts_with("P1C"), 
    names_to = "Choice_Set", 
    values_to = "choice"
  ) %>%
  mutate(
    Choice_Set = str_remove(Choice_Set, "P1C"), # remove prefix
    Choice_Set = as.integer(Choice_Set),        # convert to numeric
    id = id,
    Profile = Profile
  ) %>%
  select(id, Profile, Choice_Set, choice, 1:53)

p1 <- merge(profile_long_1, design_raw,
                     by.x = c("Choice_Set", "Profile"),
                     by.y = c("Choice Set", "Profile"),
                     all.x = TRUE)

p1 <- p1 %>% arrange(p1$id) %>% 
  relocate(3, .before = 1)
```

Then, repeat again until profile 2 to 4. As you can see below, I added *p2, p3, and p4*.

```{r Repeat again for profile 2 to 4,include=FALSE}
profile_long_2 <- profile_2 %>%
  pivot_longer(
    cols = starts_with("P2C"), 
    names_to = "Choice_Set", 
    values_to = "choice"
  ) %>%
  mutate(
    Choice_Set = str_remove(Choice_Set, "P2C"), # remove prefix
    Choice_Set = as.integer(Choice_Set),        # convert to numeric
    id = id,                                
    Profile = Profile
  ) %>%
  select(id, Profile, Choice_Set, choice, 1:53)

p2 <- merge(profile_long_2, design_raw,
                     by.x = c("Choice_Set", "Profile"),
                     by.y = c("Choice Set", "Profile"),
                     all.x = TRUE)

p2 <- p2 %>% arrange(p2$id) %>% 
  relocate(3, .before = 1)

profile_long_3 <- profile_3 %>%
  pivot_longer(
    cols = starts_with("P3C"), 
    names_to = "Choice_Set", 
    values_to = "choice"
  ) %>%
  mutate(
    Choice_Set = str_remove(Choice_Set, "P3C"), # remove prefix
    Choice_Set = as.integer(Choice_Set),        # convert to numeric
    id = id,                                
    Profile = Profile
  ) %>%
  select(id, Profile, Choice_Set, choice, 1:53)

p3 <- merge(profile_long_3, design_raw,
                     by.x = c("Choice_Set", "Profile"),
                     by.y = c("Choice Set", "Profile"),
                     all.x = TRUE)

p3 <- p3 %>% arrange(p3$id) %>% 
  relocate(3, .before = 1)

profile_long_4 <- profile_4 %>%
  pivot_longer(
    cols = starts_with("P4C"), 
    names_to = "Choice_Set", 
    values_to = "choice"
  ) %>%
  mutate(
    Choice_Set = str_remove(Choice_Set, "P4C"), # remove prefix
    Choice_Set = as.integer(Choice_Set),        # convert to numeric
    id = id,                                
    Profile = Profile
  ) %>%
  select(id, Profile, Choice_Set, choice, 1:53)

p4 <- merge(profile_long_4, design_raw,
                     by.x = c("Choice_Set", "Profile"),
                     by.y = c("Choice Set", "Profile"),
                     all.x = TRUE)

p4 <- p4 %>% arrange(p4$id) %>% 
  relocate(3, .before = 1)
```

```{r merged data and cleaning}
merged_data <- bind_rows(p1, p2, p3, p4)
merged_data <- merged_data %>%
  mutate(across(c(BMI, Residence_in_Denmark, Coffee_frequency, Level_of_urbanisation, Household_Income, Gender, Level_of_Education), recode_values))
merged_data <- merged_data %>% select(-Location_of_Residence) %>% 
  relocate(54:68, .after = 4)
merged_data <- merged_data %>%
  mutate(choice = case_when(
    choice == "Coffee A" ~ 1,
    choice == "Coffee B" ~ 2,
    choice == "Coffee C" ~ 3,
    TRUE ~ NA_real_
  ))
```

## Transforming dataset for DCE analysis for Apollo library

```{r}
recode_values_choice <- function (x) {
  recode(x, "without" = 1, "fairtrade" = 2, "organic" = 3,
         "robusta" = 1, "arabica" = 2,
         "without milk" = 1, "full cream milk" = 2, "plant-based milk" = 3,
         "without sugar" = 1, "with sugar" = 2)
}

merged_data <- merged_data %>%
  mutate(across(c(6:9,11:14,16:19), recode_values_choice))

input_MNL <- merged_data %>% 
  mutate(alt1_wo_label = ifelse(alt1_sustainability == 1,1,0)) %>%
  mutate(alt1_fairtrade = ifelse(alt1_sustainability == 2,1,0)) %>%
  mutate(alt1_organic = ifelse(alt1_sustainability == 3,1,0)) %>%
  mutate(alt1_robusta = ifelse(alt1_roasting == 1,1,0)) %>%
  mutate(alt1_arabica = ifelse(alt1_roasting == 2,1,0)) %>%
  mutate(alt1_wo_milk = ifelse(alt1_milk == 1,1,0)) %>% 
  mutate(alt1_full_milk = ifelse(alt1_milk == 2,1,0)) %>%
  mutate(alt1_pb_milk = ifelse(alt1_milk == 3,1,0)) %>% 
  mutate(alt1_wo_sugar = ifelse(alt1_sugar == 1,1,0)) %>% 
  mutate(alt1_with_sugar = ifelse(alt1_sugar == 2,1,0)) %>% 
  mutate(alt2_wo_label = ifelse(alt2_sustainability == 1,1,0)) %>%
  mutate(alt2_fairtrade = ifelse(alt2_sustainability == 2,1,0)) %>%
  mutate(alt2_organic = ifelse(alt2_sustainability == 3,1,0)) %>%
  mutate(alt2_robusta = ifelse(alt2_roasting == 1,1,0)) %>%
  mutate(alt2_arabica = ifelse(alt2_roasting == 2,1,0)) %>%
  mutate(alt2_wo_milk = ifelse(alt2_milk == 1,1,0)) %>% 
  mutate(alt2_full_milk = ifelse(alt2_milk == 2,1,0)) %>%
  mutate(alt2_pb_milk = ifelse(alt2_milk == 3,1,0)) %>% 
  mutate(alt2_wo_sugar = ifelse(alt2_sugar == 1,1,0)) %>% 
  mutate(alt2_with_sugar = ifelse(alt2_sugar == 2,1,0)) %>% 
  mutate(alt3_wo_label = ifelse(alt3_sustainability == 1,1,0)) %>%
  mutate(alt3_fairtrade = ifelse(alt3_sustainability == 2,1,0)) %>%
  mutate(alt3_organic = ifelse(alt3_sustainability == 3,1,0)) %>%
  mutate(alt3_robusta = ifelse(alt3_roasting == 1,1,0)) %>%
  mutate(alt3_arabica = ifelse(alt3_roasting == 2,1,0)) %>%
  mutate(alt3_wo_milk = ifelse(alt3_milk == 1,1,0)) %>% 
  mutate(alt3_full_milk = ifelse(alt3_milk == 2,1,0)) %>%
  mutate(alt3_pb_milk = ifelse(alt3_milk == 3,1,0)) %>% 
  mutate(alt3_wo_sugar = ifelse(alt3_sugar == 1,1,0)) %>% 
  mutate(alt3_with_sugar = ifelse(alt3_sugar == 2,1,0))
  
input_MNL <- input_MNL %>% 
  select(-c(6:9,11:14,16:19))

input_MNL <- input_MNL %>% 
  select(1:5, 57:66, 6, 67:76, 7, 77:86, 49:56, everything())
```

## Export Data

There are 2 data that we explorted:
1. *input_MNL* for Discrete Choice Experiment Analysis for Apollo library
2. *df2* for Descriptive Analysis of Danish online survey respondents

```{r Data 1}
write_csv(input_MNL,"input_MNL.csv")
```

```{r Data 2}
write_csv(df2,"df2.csv")
```